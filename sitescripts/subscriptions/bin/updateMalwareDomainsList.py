# coding: utf-8

# This Source Code is subject to the terms of the Mozilla Public License
# version 2.0 (the "License"). You can obtain a copy of the License at
# http://mozilla.org/MPL/2.0/.

import os, subprocess, codecs, urllib, zipfile, tempfile, shutil
from StringIO import StringIO
from sitescripts.utils import get_config, setupStderr

if __name__ == '__main__':
  setupStderr()

  repository = get_config().get('subscriptionDownloads', 'malwaredomains_repository')
  tempdir = tempfile.mkdtemp(prefix='malwaredomains')
  try:
    subprocess.Popen(['hg', '-q', 'clone',  '-U', repository, tempdir]).communicate()
    subprocess.Popen(['hg', '-q', 'up', '-R', tempdir, '-r', 'default']).communicate()

    path = os.path.join(tempdir, 'malwaredomains_full.txt')
    file = codecs.open(path, 'wb', encoding='utf-8')

    print >>file, '''[Adblock Plus 1.1]
! This is a list of malware domains generated from malwaredomains.com data.
! Homepage: http://malwaredomains.com/?page_id=2
! Last modified: %timestamp%
! Expires: 1d
!'''

    data = urllib.urlopen('http://mirror3.malwaredomains.com/files/justdomains.zip').read()
    zip = zipfile.ZipFile(StringIO(data), 'r')
    info = zip.infolist()[0]
    for line in str(zip.read(info.filename)).splitlines():
      if not line:
        continue
      print >>file, '||%s^' % line.strip().decode('iso-8859-1')
    file.close();

    subprocess.Popen(['hg', '-q', 'commit', '-R', tempdir, '-A', '-u', 'hgbot', '-m', 'Updated malwaredomains.com data']).communicate()
    subprocess.Popen(['hg', '-q', 'push', '-R', tempdir]).communicate()
  finally:
    shutil.rmtree(tempdir, ignore_errors=True)
