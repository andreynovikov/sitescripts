<!-- This Source Code is subject to the terms of the Mozilla Public License
   - version 2.0 (the "License"). You can obtain a copy of the License at
   - http://mozilla.org/MPL/2.0/. -->

<!DOCTYPE html>
<html lang="en">
<head>
<title>Issue reports for {{email}}</title>
<link rel="stylesheet" href="/reports.css" type="text/css" />
<style type="text/css">
#filters,
#reportList
{
  width: 100%;
}
#filters td
{
  border: none;
}
#reportTemplate
{
  display: none;
}
.reportTime
{
  text-align: right;
}
.reportScreenshot,
.reportContact,
.reportKnown,
.reportNumSubs
{
  text-align: center;
}
.reportScreenshot,
.reportContact
{
  color: #00C000;
}
.reportKnown
{
  color: #C00000;
}
</style>
<script type="text/javascript">
var reports = {{reports|json(indent=2,ensure_ascii=False)|safe}};

var currentTime = unixtime();
var currentPeriod = currentTime - 24 * 3600;
var currentSort = compareRelevance;
var onlyWithScreenshot = false;
var onlyWithEmail = false;
var onlyWithComment = false;
var onlyWithoutKnown = false;
var onlyWithoutStatus = false;
var sites = {};
var populateTableCalls = 1;

function addReportEntry(tbody, report)
{
  var template = document.getElementById("reportTemplate");
  var element = template.cloneNode(true);
  element.removeAttribute("id");
  
  var type = element.getElementsByClassName("reportType")[0];
  type.textContent = report.type;

  var time = element.getElementsByClassName("reportTime")[0];
  time.textContent = new Date(report.time * 1000).toLocaleDateString();
  time.title = new Date(report.time * 1000).toLocaleString();

  var status = element.getElementsByClassName("reportStatus")[0];
  var s = truncate(report.status, 25, true);
  status.textContent = s;
  if (s != report.status)
    status.title = report.status;

  if (report.email != null)
  {
    var contact = element.getElementsByClassName("reportContact")[0];
    contact.textContent = "✓";
    contact.title = report.email;
  }

  if (report.screenshot)
  {
    var screenshot = element.getElementsByClassName("reportScreenshot")[0];
    screenshot.textContent = (report.screenshotEdited ? "✔" : "✓");
  }

  if (report.knownIssues > 0)
  {
    var known = element.getElementsByClassName("reportKnown")[0];
    known.textContent = "✓";
  }

  var numSubs = element.getElementsByClassName("reportNumSubs")[0];
  numSubs.textContent = report.numSubscriptions;
  numSubs.title = report.subscriptions.map(function(x) {return x.name;}).join(", ");

  var href = element.getElementsByClassName("reportHref")[0];
  href.href = report.url;

  var site = element.getElementsByClassName("reportSite")[0];
  site.textContent = report.site;

  var comment = element.getElementsByClassName("reportComment")[0];
  var c = truncate(report.comment, 25, true);
  comment.textContent = c;
  if (c != report.comment)
    comment.title = report.comment;

  tbody.appendChild(element);
}

function truncate(s, n, useWordBoundary)
{
  if (s.length <= n)
    return s;
	var s_ = s.substr(0, n-1);
  if (useWordBoundary && s_.lastIndexOf(' ') > 0)
    s_ = s_.substr(0, s_.lastIndexOf(' '));
  return  s_ + "…";
}
  
function init()
{
  for (var i = 0; i < reports.length; i++)
  {
    reports[i].weight = calculateReportWeight(reports[i]);
  }
  updateFilters();
  updateDisplayedPeriod();
  updateSortFunction();
  populateTableCalls = 0;
  populateTable();
}

function populateTable()
{
  populateTableCalls++;
  if (populateTableCalls > 1)
    return;
  
  var tbody = document.getElementById("reportList").tBodies[0];

  // clear table
  var range = document.createRange();
  range.selectNodeContents(tbody);
  range.deleteContents();

  // period and filters
  var r = reports.filter(filterReports);
  
  // sort
  if (currentSort == compareSite)
  {
    sites = {};
    for (var i = 0; i < r.length; i++)
    {
      if (! sites[r[i].site])
        sites[r[i].site] = 1;
      else
        sites[r[i].site]++;
    }
  }
  r.sort(currentSort);

  var offset = 0;
  var count = 1000;

  function addRows()
  {
    // add items
    var limit = offset + count;
    if (limit > r.length)
      limit = r.length;
    for (var i = offset; i < limit; i++)
    {
      addReportEntry(tbody, r[i]);
    }

    if (limit < r.length)
    {
      if (populateTableCalls == 1)
      {
        offset += count;
        setTimeout(addRows, 0);
      }
      else
      {
        populateTableCalls = 0;
        setTimeout(populateTable, 0);
      }
    }
    else
    {
      populateTableCalls = 0;
    }
  }
  setTimeout(addRows, 0);
}

function updateDisplayedPeriod()
{
  var select = document.getElementById("period");
  var option = select.options[select.selectedIndex].value;
  currentPeriod = currentTime - parseInt(option) * 3600;
  populateTable();
}

function updateSortFunction()
{
  var select = document.getElementById("sort");
  var option = select.options[select.selectedIndex].value;
  if (option == "relevance")
    currentSort = compareRelevance;
  else if (option == "site")
    currentSort = compareSite;
  else if (option == "time")
    currentSort = compareTime;
  populateTable();
}

function updateFilters()
{
  onlyWithScreenshot = document.getElementById('screenshot').checked;
  onlyWithEmail = document.getElementById('email').checked;
  onlyWithComment = document.getElementById('comment').checked;
  onlyWithoutKnown = document.getElementById('known').checked;
  onlyWithoutStatus = document.getElementById('status').checked;
  populateTable();
}

function filterReports(element, index, array)
{
  return (
          element.time >= currentPeriod &&
          (! onlyWithScreenshot || element.screenshot) &&
          (! onlyWithEmail || element.email != null) &&
          (! onlyWithoutStatus || element.status == "") &&
          (! onlyWithoutKnown || element.knownIssues == 0) &&
          (! onlyWithComment || element.comment != "")
         );
}

function compareSite(a,b)
{
  if (sites[a.site] != sites[b.site])
    return sites[b.site] - sites[a.site];
  if (a.site < b.site)
    return -1;
  if (a.site > b.site)
    return 1;
  return compareRelevance(a,b);
}

function compareRelevance(a,b)
{
  if (a.weight < b.weight)
     return 1;
  if (a.weight > b.weight)
    return -1;
  return compareTime(a, b);
}

function compareTime(a,b)
{
  return b.time - a.time;
}

function calculateReportWeight(report)
{
//  var startTime
  var weight = 1.0;
  if (report.type == 'false positive' || report.type == 'false negative')
    weight /= report.subscriptions.length;
  if (report.screenshot && report.screenshotEdited)
    weight += 0.7;
  else if (report.screenshot)
    weight += 0.3;
  if (report.knownIssues > 0)
    weight -= 0.3;
  if (report.comment.match(/\btest\b/i))
    weight -= 0.5;
  else if (report.comment.match(/\S/))
    weight += 0.5;
  if (report.email != null)
    weight += 0.3;

  return weight;
}

function unixtime()
{
  return parseInt(new Date().getTime()/1000);
}
</script>
</head>
<body onload="init()">
  <p class="header"> Adblock Plus issue reports for {{email}}</p>
  <table id="filters">
    <tr><td>
      <table>
        <tr><td>
          Filters:
        </td><td>
          <input type="checkbox" id="email" onclick="updateFilters()"><label for="email"> only with contact address</label><br/>
          <input type="checkbox" id="comment" onclick="updateFilters()"><label for="comment"> only with comment</label><br/>
          <input type="checkbox" id="screenshot" onclick="updateFilters()"><label for="screenshot"> only with screenshot</label><br/>
        </td><td>
          <input type="checkbox" id="known" onclick="updateFilters()"><label for="known"> only without known issues</label><br/>
          <input type="checkbox" id="status" onclick="updateFilters()"><label for="status"> only without status</label><br/>
        </td></tr>
      </table>
    </td><td style="text-align: right; vertical-align: bottom">
      Period: <select id="period" onchange="updateDisplayedPeriod()"><option value="24">last 24 hours</option><option value="168">last week</option><option value="8760">all</option></select>
      Sort by: <select id="sort" onchange="updateSortFunction()"><option value="relevance">relevance</option><option value="site">site</option><option value="time">time</option></select>
    </td></tr>
  </table>
  <table id="reportList">
    <thead>
      <tr>
        <th>Report type</th>
        <th>Time</th>
        <th>Status</th>
        <th title="Has contact address">Contact</th>
        <th>Screenshot</th>
        <th title="Matches known issues">Known</th>
        <th title="Number of filter subscriptions">Subscriptions</th>
        <th>Site</th>
        <th>Comment</th>
        <th>Link</th>
      </tr>
      <tr id="reportTemplate">
        <td class="reportType">
        </td><td class="reportTime">
        </td><td class="reportStatus">
        </td><td class="reportContact">
        </td><td class="reportScreenshot">
        </td><td class="reportKnown">
        </td><td class="reportNumSubs">
        </td><td class="reportSite">
        </td><td class="reportComment">
        </td><td class="reportLink">
        <a class="reportHref">view</a>
        </td>
      </tr>
    </thead>
    <tbody>
    </tbody>
  </table>
</body>
</html>
